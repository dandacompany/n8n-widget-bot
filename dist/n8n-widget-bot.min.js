!function(e,t){"use strict";const n={apiUrl:"{{your_n8n_api}}",position:"bottom-right",themeColor:"#4C4CBBFF",bubbleIcon:'<i class="fas fa-comments"></i>',title:"n8n Chatbot",placeholder:"Type your message...",welcomeMessage:"Hello! Type your message...",zIndex:9999,width:350,height:500,fontFamily:"inherit",debug:!1,sessionId:void 0,animationDuration:300,typingSpeed:18,maxMessageLength:1e3,resizable:!0,minWidth:300,maxWidth:600,minHeight:400,maxHeight:800};function s(...e){c._config&&c._config.debug&&console.log("[FloatingChatWidget]",...e)}const i={generateSessionId:()=>"fcw-"+Math.random().toString(36).slice(2)+Date.now(),elementExists:e=>null!==t.getElementById(e),createElement(e,n="",s=""){const i=t.createElement(e);return n&&(i.className=n),s&&(i.innerHTML=s),i},formatMarkdown(e){if(!e)return"";let t=e.replace(/\n/g,"<br>").replace(/\*\*(.+?)\*\*/g,"<b>$1</b>").replace(/\*(.+?)\*/g,"<i>$1</i>").replace(/\- (.+)/g,"<li>$1</li>");return/<li>/.test(t)&&(t="<ul>"+t+"</ul>"),t},validateMessageLength:(e,t)=>e&&e.length<=t},r={createStyles(e){if(i.elementExists("floating-chat-widget-style"))return;const n=i.createElement("style","",this.generateStyleString(e));n.id="floating-chat-widget-style",t.head.appendChild(n)},generateStyleString(e){const t="bottom-left"===e.position?"left: 24px;":"right: 24px;",n=e.themeColor;return`\n        .fcw-bubble {\n          position: fixed;\n          ${t}\n          bottom: 24px;\n          z-index: ${e.zIndex};\n          background: ${n};\n          color: #fff;\n          width: 56px;\n          height: 56px;\n          border-radius: 50%;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 2rem;\n          box-shadow: 0 2px 12px rgba(0,0,0,0.15);\n          cursor: pointer;\n          transition: box-shadow 0.2s, transform 0.2s, background 0.2s;\n        }\n        .fcw-bubble:hover {\n          box-shadow: 0 4px 24px rgba(0,0,0,0.25);\n          transform: scale(1.05);\n          background: ${this.lightenColor(n,20)};\n        }\n        .fcw-emoji-bubble,\n        .fcw-bubble i {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 1.15rem;\n          width: 24px;\n          height: 24px;\n          line-height: 1;\n          margin: 0;\n          padding: 0;\n        }\n        .fcw-widget {\n          position: fixed;\n          ${t}\n          bottom: 90px;\n          z-index: ${e.zIndex};\n          width: ${e.width}px;\n          max-width: 95vw;\n          min-width: ${e.minWidth}px;\n          height: ${e.height}px;\n          max-height: 80vh;\n          min-height: ${e.minHeight}px;\n          background: #fff0f6;\n          border-radius: 16px;\n          box-shadow: 0 8px 32px rgba(255,105,180,0.10);\n          display: flex;\n          flex-direction: column;\n          overflow: hidden;\n          opacity: 0;\n          pointer-events: none;\n          transform: translateY(30px) scale(0.98);\n          transition: opacity ${e.animationDuration}ms, transform ${e.animationDuration}ms;\n          resize: none; /* Disable browser default resize */\n        }\n        .fcw-widget.open {\n          opacity: 1;\n          pointer-events: auto;\n          transform: translateY(0) scale(1);\n        }\n        .fcw-header {\n          background: ${n};\n          color: #fff;\n          padding: 16px;\n          font-size: 1.1rem;\n          font-family: ${e.fontFamily};\n          font-weight: bold;\n          border-top-left-radius: 16px;\n          border-top-right-radius: 16px;\n          box-shadow: 0 2px 8px rgba(255,105,180,0.08);\n        }\n        .fcw-messages {\n          flex: 1;\n          padding: 16px;\n          overflow-y: auto;\n          background: #fff0f6;\n          font-family: ${e.fontFamily};\n        }\n        .fcw-message {\n          margin-bottom: 12px;\n          display: flex;\n        }\n        .fcw-message.user {\n          justify-content: flex-end;\n        }\n        .fcw-message.bot {\n          justify-content: flex-start;\n        }\n        .fcw-bubble-text {\n          background: #ffe0ef;\n          color: #d72660;\n          border-radius: 16px;\n          padding: 10px 16px;\n          max-width: 80%;\n          font-size: 1rem;\n          word-break: break-word;\n          box-shadow: 0 1px 4px rgba(255,105,180,0.08);\n        }\n        .fcw-message.user .fcw-bubble-text {\n          background: ${n};\n          color: #fff;\n          box-shadow: 0 2px 8px rgba(255,105,180,0.13);\n        }\n        .fcw-input-row {\n          display: flex;\n          border-top: 1px solid #ffd1e6;\n          background: #fff0f6;\n        }\n        .fcw-input {\n          flex: 1;\n          border: none;\n          padding: 12px;\n          font-size: 1rem;\n          font-family: ${e.fontFamily};\n          outline: none;\n          background: transparent;\n        }\n        .fcw-input:focus {\n          background: #ffe0ef;\n        }\n        .fcw-send-btn {\n          background: none;\n          border: none;\n          color: ${n};\n          font-size: 1.5rem;\n          padding: 0 16px;\n          cursor: pointer;\n          transition: color 0.2s, background 0.2s;\n          border-radius: 50%;\n        }\n        .fcw-send-btn:hover:not(:disabled) {\n          background: #ffb3d6;\n          color: #fff;\n        }\n        .fcw-send-btn:disabled {\n          color: #ffc1e3;\n          cursor: not-allowed;\n        }\n        .fcw-loading {\n          display: inline-block;\n          letter-spacing: 2px;\n          animation: fcw-blink 1s infinite steps(1, end);\n        }\n        @keyframes fcw-blink {\n          0%, 100% { opacity: 1; }\n          50% { opacity: 0.3; }\n        }\n        .fcw-error {\n          color: #ff4444;\n          font-size: 0.9rem;\n          margin-top: 5px;\n        }\n        .fcw-css-bubble-modern {\n          display: inline-block;\n          width: 22px;\n          height: 18px;\n          background: #fff;\n          border-radius: 12px 12px 16px 16px;\n          position: relative;\n          box-shadow: 0 2px 8px rgba(0,0,0,0.13);\n          vertical-align: middle;\n        }\n        .fcw-css-bubble-modern::after {\n          content: '';\n          position: absolute;\n          left: 8px;\n          bottom: -7px;\n          width: 8px;\n          height: 8px;\n          background: #fff;\n          border-radius: 0 0 8px 8px;\n          transform: rotate(18deg);\n          box-shadow: 0 2px 8px rgba(0,0,0,0.10);\n        }\n        .fcw-resize-handle {\n          position: absolute;\n          background: rgba(0, 0, 0, 0.1);\n          transition: background-color 0.2s;\n          z-index: 10;\n        }\n        .fcw-resize-handle:hover {\n          background: rgba(0, 0, 0, 0.2);\n        }\n        \n        /* Corner handles */\n        .fcw-resize-nw, .fcw-resize-ne, .fcw-resize-sw, .fcw-resize-se {\n          width: 12px;\n          height: 12px;\n        }\n        .fcw-resize-nw {\n          top: -6px;\n          left: -6px;\n          cursor: nw-resize;\n        }\n        .fcw-resize-ne {\n          top: -6px;\n          right: -6px;\n          cursor: ne-resize;\n        }\n        .fcw-resize-sw {\n          bottom: -6px;\n          left: -6px;\n          cursor: sw-resize;\n        }\n        .fcw-resize-se {\n          bottom: -6px;\n          right: -6px;\n          cursor: se-resize;\n        }\n        \n        /* Edge handles */\n        .fcw-resize-n, .fcw-resize-s {\n          left: 12px;\n          right: 12px;\n          height: 8px;\n        }\n        .fcw-resize-n {\n          top: -4px;\n          cursor: n-resize;\n        }\n        .fcw-resize-s {\n          bottom: -4px;\n          cursor: s-resize;\n        }\n        \n        .fcw-resize-e, .fcw-resize-w {\n          top: 12px;\n          bottom: 12px;\n          width: 8px;\n        }\n        .fcw-resize-e {\n          right: -4px;\n          cursor: e-resize;\n        }\n        .fcw-resize-w {\n          left: -4px;\n          cursor: w-resize;\n        }\n      `},lightenColor(e,t){const n=parseInt(e.replace("#",""),16),s=Math.round(2.55*t),i=(n>>16)+s,r=(n>>8&255)+s,o=(255&n)+s;return"#"+(16777216+65536*(i<255?i<1?0:i:255)+256*(r<255?r<1?0:r:255)+(o<255?o<1?0:o:255)).toString(16).slice(1)}},o={addMessage(e,t,n,r={}){const o=i.createElement("div",`fcw-message ${t}`),a=i.createElement("div","fcw-bubble-text");if(r.loading)a.innerHTML='<span class="fcw-loading">●●●</span>';else{if(r.streaming)return a.innerHTML="",o.appendChild(a),e.appendChild(o),this.scrollToBottom(e),this.streamTextToBubble(a,n),void s("Streaming message added:",t,n);a.innerHTML=i.formatMarkdown(n)}o.appendChild(a),e.appendChild(o),this.scrollToBottom(e),s("Message added:",t,n)},streamTextToBubble(e,t){let n=0;const s=i.formatMarkdown(t),r=i.createElement("div","",s),o=r.textContent||r.innerText||"",a=()=>{n<=o.length?(e.textContent=o.slice(0,n),n++,setTimeout(a,c._config.typingSpeed)):e.innerHTML=s};a()},scrollToBottom(e){e.scrollTop=e.scrollHeight},removeLoadingMessage(e){const t=e.lastChild;t&&t.querySelector(".fcw-loading")&&e.removeChild(t)}},a={isResizing:!1,resizeDirection:"",startX:0,startY:0,startWidth:0,startHeight:0,startLeft:0,startRight:0,startTop:0,startBottom:0,resizeHandles:[],createResizeHandles(e,t){if(!t.resizable)return;[{direction:"nw",cursor:"nw-resize"},{direction:"n",cursor:"n-resize"},{direction:"ne",cursor:"ne-resize"},{direction:"e",cursor:"e-resize"},{direction:"se",cursor:"se-resize"},{direction:"s",cursor:"s-resize"},{direction:"sw",cursor:"sw-resize"},{direction:"w",cursor:"w-resize"}].forEach(t=>{const n=i.createElement("div",`fcw-resize-handle fcw-resize-${t.direction}`);n.style.cursor=t.cursor,n.dataset.direction=t.direction,e.appendChild(n),this.resizeHandles.push(n)}),this.bindResizeEvents(e,t)},bindResizeEvents(e,n){this.resizeHandles.forEach(t=>{t.addEventListener("mousedown",s=>{s.preventDefault(),s.stopPropagation(),this.startResize(s,e,n,t.dataset.direction)})}),t.addEventListener("mousemove",t=>{this.isResizing&&this.handleResize(t,e,n)}),t.addEventListener("mouseup",()=>{this.stopResize()})},startResize(n,i,r,o){this.isResizing=!0,this.resizeDirection=o,this.startX=n.clientX,this.startY=n.clientY,this.startWidth=i.offsetWidth,this.startHeight=i.offsetHeight;const a=i.getBoundingClientRect();this.startLeft=a.left,this.startRight=e.innerWidth-a.right,this.startTop=a.top,this.startBottom=e.innerHeight-a.bottom,t.body.style.cursor=this.getCursorForDirection(o),t.body.style.userSelect="none",s("Resize started:",{direction:o,width:this.startWidth,height:this.startHeight,left:this.startLeft,right:this.startRight,top:this.startTop,bottom:this.startBottom})},handleResize(e,t,n){if(!this.isResizing)return;const i=e.clientX-this.startX,r=e.clientY-this.startY;let o=this.startWidth,a=this.startHeight,d=this.startLeft,c=this.startRight;switch(this.resizeDirection){case"nw":o=this.startWidth-i,a=this.startHeight-r,d=this.startLeft+i;break;case"n":a=this.startHeight-r;break;case"ne":o=this.startWidth+i,a=this.startHeight-r,c=this.startRight-i;break;case"e":o=this.startWidth+i,c=this.startRight-i;break;case"se":o=this.startWidth+i,a=this.startHeight+r,c=this.startRight-i;break;case"s":a=this.startHeight+r;break;case"sw":o=this.startWidth-i,a=this.startHeight+r,d=this.startLeft+i;break;case"w":o=this.startWidth-i,d=this.startLeft+i}o=Math.max(n.minWidth,Math.min(n.maxWidth,o)),a=Math.max(n.minHeight,Math.min(n.maxHeight,a)),t.style.width=o+"px",t.style.height=a+"px";"right"===("bottom-left"===n.position?"left":"right")?t.style.right=c+"px":t.style.left=d+"px",s("Resizing:",{direction:this.resizeDirection,width:o,height:a,deltaX:i,deltaY:r})},getCursorForDirection:e=>({nw:"nw-resize",n:"n-resize",ne:"ne-resize",e:"e-resize",se:"se-resize",s:"s-resize",sw:"sw-resize",w:"w-resize"}[e]||"default"),stopResize(){this.isResizing&&(this.isResizing=!1,t.body.style.cursor="",t.body.style.userSelect="",s("Resize ended"))}},d={async sendMessage(e,t,n){try{const s=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,sessionId:t})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);return await s.json()}catch(e){throw s("API error:",e),e}},extractReply:e=>e&&e.reply?e.reply:e&&e.output?e.output:e&&e.message?e.message:""},c={_config:{},_elements:{},_isOpen:!1,_onUserRequest:null,init(e={}){if("loading"!==t.readyState){this._config={...n,...e},this._config.sessionId||(this._config.sessionId=i.generateSessionId()),s("Initializing with config:",this._config);try{this._createStyles(),this._createWidget(),this._bindEvents(),this._config.welcomeMessage&&o.addMessage(this._elements.messages,"bot",this._config.welcomeMessage),s("Widget initialized")}catch(e){s("Initialization error:",e)}}else t.addEventListener("DOMContentLoaded",()=>this.init(e))},onUserRequest(e){this._onUserRequest=e},reply(e){i.validateMessageLength(e,this._config.maxMessageLength)?o.addMessage(this._elements.messages,"bot",e):s("Message too long:",e.length)},toggle(){this._toggleWidget()},open(){this._isOpen||this._toggleWidget()},close(){this._isOpen&&this._toggleWidget()},_createStyles(){r.createStyles(this._config)},_createWidget(){const e=i.createElement("div","fcw-bubble",this._config.bubbleIcon);t.body.appendChild(e);const n=i.createElement("div","fcw-widget",`\n        <div class="fcw-header">${this._config.title}</div>\n        <div class="fcw-messages"></div>\n        <form class="fcw-input-row" autocomplete="off">\n          <input class="fcw-input" type="text" placeholder="${this._config.placeholder}" maxlength="${this._config.maxMessageLength}" />\n          <button class="fcw-send-btn" type="submit">➤</button>\n        </form>\n      `);t.body.appendChild(n),this._elements={bubble:e,widget:n,messages:n.querySelector(".fcw-messages"),input:n.querySelector(".fcw-input"),form:n.querySelector(".fcw-input-row"),sendBtn:n.querySelector(".fcw-send-btn")},a.createResizeHandles(n,this._config)},_bindEvents(){this._elements.bubble.addEventListener("click",()=>this._toggleWidget()),this._elements.form.addEventListener("submit",e=>{e.preventDefault(),this._handleFormSubmit()}),this._elements.input.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this._handleFormSubmit())})},_handleFormSubmit(){const e=this._elements.input.value.trim();e&&(i.validateMessageLength(e,this._config.maxMessageLength)?(o.addMessage(this._elements.messages,"user",e),this._elements.input.value="",this._elements.input.focus(),"function"==typeof this._onUserRequest?this._onUserRequest(e):this._sendToApi(e)):this._showError("Message is too long."))},_showError(e){const t=i.createElement("div","fcw-error",e);this._elements.messages.appendChild(t),o.scrollToBottom(this._elements.messages),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},3e3)},_toggleWidget(){this._isOpen=!this._isOpen,this._isOpen?(this._elements.widget.classList.add("open"),setTimeout(()=>this._elements.input.focus(),this._config.animationDuration+50)):this._elements.widget.classList.remove("open"),s("Widget toggled:",this._isOpen)},async _sendToApi(e){o.addMessage(this._elements.messages,"bot","",{loading:!0});try{const t=await d.sendMessage(e,this._config.sessionId,this._config.apiUrl);o.removeLoadingMessage(this._elements.messages);const n=d.extractReply(t);n?o.addMessage(this._elements.messages,"bot",n,{streaming:!0}):(s("API raw response:",t),o.addMessage(this._elements.messages,"bot","Sorry, I did not understand."))}catch(e){o.removeLoadingMessage(this._elements.messages),s("API error:",e),o.addMessage(this._elements.messages,"bot","AI agent connection error occurred.")}}};e.FloatingChatWidget=c}(window,document);