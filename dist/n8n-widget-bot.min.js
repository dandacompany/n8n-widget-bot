!function(e,t){"use strict";const n={apiUrl:"{{your_n8n_api}}",position:"bottom-right",themeColor:"#4C4CBBFF",bubbleIcon:'<i class="fas fa-comments"></i>',title:"n8n Chatbot",placeholder:"Type your message...",welcomeMessage:"Hello! Type your message...",zIndex:9999,width:350,height:500,fontFamily:"inherit",debug:!1,sessionId:void 0,animationDuration:300,typingSpeed:18,maxMessageLength:1e3,resizable:!0,minWidth:300,maxWidth:600,minHeight:400,maxHeight:800,enableFileUpload:!0,maxFileSize:10485760,allowedFileTypes:["image/*","application/pdf",".doc",".docx",".txt",".csv",".xlsx"]},i={generateSessionId:()=>"fcw-"+Math.random().toString(36).slice(2)+Date.now(),elementExists:e=>null!==t.getElementById(e),createElement(e,n="",i=""){const s=t.createElement(e);return n&&(s.className=n),i&&(s.innerHTML=i),s},formatMarkdown(e){if(!e)return"";let t=e.replace(/\n/g,"<br>").replace(/\*\*(.+?)\*\*/g,"<b>$1</b>").replace(/\*(.+?)\*/g,"<i>$1</i>").replace(/\- (.+)/g,"<li>$1</li>");return/<li>/.test(t)&&(t="<ul>"+t+"</ul>"),t},validateMessageLength:(e,t)=>e&&e.length<=t,fileToBase64:async e=>new Promise((t,n)=>{const i=new FileReader;i.readAsDataURL(e),i.onload=()=>t(i.result),i.onerror=e=>n(e)}),formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]},validateFile(e,t){if(e.size>t.maxFileSize)return{valid:!1,error:`File size exceeds maximum limit of ${this.formatFileSize(t.maxFileSize)}`};const n=e.type,i=e.name.toLowerCase();let s=!1;for(const e of t.allowedFileTypes)if(e.startsWith(".")){if(i.endsWith(e)){s=!0;break}}else if(e.endsWith("/*")){const t=e.slice(0,-2);if(n.startsWith(t)){s=!0;break}}else if(n===e){s=!0;break}return s?{valid:!0}:{valid:!1,error:"File type not allowed"}}},s={createStyles(e){if(i.elementExists("floating-chat-widget-style"))return;const n=i.createElement("style","",this.generateStyleString(e));n.id="floating-chat-widget-style",t.head.appendChild(n)},generateStyleString(e){const t="bottom-left"===e.position?"left: 24px;":"right: 24px;",n=e.themeColor;return`\n        .fcw-bubble {\n          position: fixed;\n          ${t}\n          bottom: 24px;\n          z-index: ${e.zIndex};\n          background: ${n};\n          color: #fff;\n          width: 56px;\n          height: 56px;\n          border-radius: 50%;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 2rem;\n          box-shadow: 0 2px 12px rgba(0,0,0,0.15);\n          cursor: pointer;\n          transition: box-shadow 0.2s, transform 0.2s, background 0.2s;\n        }\n        .fcw-bubble:hover {\n          box-shadow: 0 4px 24px rgba(0,0,0,0.25);\n          transform: scale(1.05);\n          background: ${this.lightenColor(n,20)};\n        }\n        .fcw-emoji-bubble,\n        .fcw-bubble i {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 1.15rem;\n          width: 24px;\n          height: 24px;\n          line-height: 1;\n          margin: 0;\n          padding: 0;\n        }\n        .fcw-widget {\n          position: fixed;\n          ${t}\n          bottom: 90px;\n          z-index: ${e.zIndex};\n          width: ${e.width}px;\n          max-width: 95vw;\n          min-width: ${e.minWidth}px;\n          height: ${e.height}px;\n          max-height: 80vh;\n          min-height: ${e.minHeight}px;\n          background: #fff0f6;\n          border-radius: 16px;\n          box-shadow: 0 8px 32px rgba(255,105,180,0.10);\n          display: flex;\n          flex-direction: column;\n          overflow: hidden;\n          opacity: 0;\n          pointer-events: none;\n          transform: translateY(30px) scale(0.98);\n          transition: opacity ${e.animationDuration}ms, transform ${e.animationDuration}ms;\n          resize: none; /* Disable browser default resize */\n        }\n        .fcw-widget.open {\n          opacity: 1;\n          pointer-events: auto;\n          transform: translateY(0) scale(1);\n        }\n        .fcw-header {\n          background: ${n};\n          color: #fff;\n          padding: 16px;\n          font-size: 1.1rem;\n          font-family: ${e.fontFamily};\n          font-weight: bold;\n          border-top-left-radius: 16px;\n          border-top-right-radius: 16px;\n          box-shadow: 0 2px 8px rgba(255,105,180,0.08);\n        }\n        .fcw-messages {\n          flex: 1;\n          padding: 16px;\n          overflow-y: auto;\n          background: #fff0f6;\n          font-family: ${e.fontFamily};\n        }\n        .fcw-message {\n          margin-bottom: 12px;\n          display: flex;\n        }\n        .fcw-message.user {\n          justify-content: flex-end;\n        }\n        .fcw-message.bot {\n          justify-content: flex-start;\n        }\n        .fcw-bubble-text {\n          background: #ffe0ef;\n          color: #d72660;\n          border-radius: 16px;\n          padding: 10px 16px;\n          max-width: 80%;\n          font-size: 1rem;\n          word-break: break-word;\n          box-shadow: 0 1px 4px rgba(255,105,180,0.08);\n        }\n        .fcw-message.user .fcw-bubble-text {\n          background: ${n};\n          color: #fff;\n          box-shadow: 0 2px 8px rgba(255,105,180,0.13);\n        }\n        .fcw-input-row {\n          display: flex;\n          border-top: 1px solid #ffd1e6;\n          background: #fff0f6;\n        }\n        .fcw-input {\n          flex: 1;\n          border: none;\n          padding: 12px;\n          font-size: 1rem;\n          font-family: ${e.fontFamily};\n          outline: none;\n          background: transparent;\n        }\n        .fcw-input:focus {\n          background: #ffe0ef;\n        }\n        .fcw-file-btn {\n          background: none;\n          border: none;\n          color: ${n};\n          font-size: 1.3rem;\n          padding: 0 12px;\n          cursor: pointer;\n          transition: color 0.2s, background 0.2s;\n          border-radius: 50%;\n          position: relative;\n        }\n        .fcw-file-btn:hover:not(:disabled) {\n          background: #ffb3d6;\n          color: #fff;\n        }\n        .fcw-file-btn:disabled {\n          color: #ffc1e3;\n          cursor: not-allowed;\n        }\n        .fcw-file-input {\n          position: absolute;\n          top: 0;\n          left: 0;\n          opacity: 0;\n          width: 100%;\n          height: 100%;\n          cursor: pointer;\n        }\n        .fcw-send-btn {\n          background: none;\n          border: none;\n          color: ${n};\n          font-size: 1.5rem;\n          padding: 0 16px;\n          cursor: pointer;\n          transition: color 0.2s, background 0.2s;\n          border-radius: 50%;\n        }\n        .fcw-send-btn:hover:not(:disabled) {\n          background: #ffb3d6;\n          color: #fff;\n        }\n        .fcw-send-btn:disabled {\n          color: #ffc1e3;\n          cursor: not-allowed;\n        }\n        .fcw-file-preview {\n          background: #ffe0ef;\n          color: #d72660;\n          padding: 8px;\n          margin: 8px;\n          border-radius: 8px;\n          font-size: 0.9rem;\n          max-height: 120px;\n          overflow-y: auto;\n        }\n        .fcw-files-container {\n          display: flex;\n          flex-direction: column;\n          gap: 6px;\n        }\n        .fcw-file-item {\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n          padding: 4px 8px;\n          background: rgba(255, 255, 255, 0.5);\n          border-radius: 6px;\n        }\n        .fcw-file-item:hover {\n          background: rgba(255, 255, 255, 0.7);\n        }\n        .fcw-file-info {\n          flex: 1;\n          display: flex;\n          align-items: center;\n          overflow: hidden;\n        }\n        .fcw-file-info span {\n          overflow: hidden;\n          text-overflow: ellipsis;\n          white-space: nowrap;\n        }\n        .fcw-file-remove {\n          background: none;\n          border: none;\n          color: #d72660;\n          cursor: pointer;\n          font-size: 1.2rem;\n          padding: 0 4px;\n          margin-left: 8px;\n          transition: color 0.2s;\n          flex-shrink: 0;\n        }\n        .fcw-file-remove:hover {\n          color: #ff4444;\n        }\n        .fcw-message.user.file {\n          flex-direction: column;\n          align-items: flex-end;\n        }\n        .fcw-file-message {\n          background: ${n};\n          color: #fff;\n          border-radius: 16px;\n          padding: 10px 16px;\n          margin-bottom: 8px;\n          max-width: 80%;\n          font-size: 0.9rem;\n          box-shadow: 0 2px 8px rgba(255,105,180,0.13);\n        }\n        .fcw-file-icon {\n          margin-right: 8px;\n        }\n        .fcw-loading {\n          display: inline-block;\n          letter-spacing: 2px;\n          animation: fcw-blink 1s infinite steps(1, end);\n        }\n        @keyframes fcw-blink {\n          0%, 100% { opacity: 1; }\n          50% { opacity: 0.3; }\n        }\n        .fcw-error {\n          color: #ff4444;\n          font-size: 0.9rem;\n          margin-top: 5px;\n        }\n        .fcw-css-bubble-modern {\n          display: inline-block;\n          width: 22px;\n          height: 18px;\n          background: #fff;\n          border-radius: 12px 12px 16px 16px;\n          position: relative;\n          box-shadow: 0 2px 8px rgba(0,0,0,0.13);\n          vertical-align: middle;\n        }\n        .fcw-css-bubble-modern::after {\n          content: '';\n          position: absolute;\n          left: 8px;\n          bottom: -7px;\n          width: 8px;\n          height: 8px;\n          background: #fff;\n          border-radius: 0 0 8px 8px;\n          transform: rotate(18deg);\n          box-shadow: 0 2px 8px rgba(0,0,0,0.10);\n        }\n        .fcw-resize-handle {\n          position: absolute;\n          background: rgba(0, 0, 0, 0.1);\n          transition: background-color 0.2s;\n          z-index: 10;\n        }\n        .fcw-resize-handle:hover {\n          background: rgba(0, 0, 0, 0.2);\n        }\n        \n        /* Corner handles */\n        .fcw-resize-nw, .fcw-resize-ne, .fcw-resize-sw, .fcw-resize-se {\n          width: 12px;\n          height: 12px;\n        }\n        .fcw-resize-nw {\n          top: -6px;\n          left: -6px;\n          cursor: nw-resize;\n        }\n        .fcw-resize-ne {\n          top: -6px;\n          right: -6px;\n          cursor: ne-resize;\n        }\n        .fcw-resize-sw {\n          bottom: -6px;\n          left: -6px;\n          cursor: sw-resize;\n        }\n        .fcw-resize-se {\n          bottom: -6px;\n          right: -6px;\n          cursor: se-resize;\n        }\n        \n        /* Edge handles */\n        .fcw-resize-n, .fcw-resize-s {\n          left: 12px;\n          right: 12px;\n          height: 8px;\n        }\n        .fcw-resize-n {\n          top: -4px;\n          cursor: n-resize;\n        }\n        .fcw-resize-s {\n          bottom: -4px;\n          cursor: s-resize;\n        }\n        \n        .fcw-resize-e, .fcw-resize-w {\n          top: 12px;\n          bottom: 12px;\n          width: 8px;\n        }\n        .fcw-resize-e {\n          right: -4px;\n          cursor: e-resize;\n        }\n        .fcw-resize-w {\n          left: -4px;\n          cursor: w-resize;\n        }\n      `},lightenColor(e,t){const n=parseInt(e.replace("#",""),16),i=Math.round(2.55*t),s=(n>>16)+i,o=(n>>8&255)+i,r=(255&n)+i;return"#"+(16777216+65536*(s<255?s<1?0:s:255)+256*(o<255?o<1?0:o:255)+(r<255?r<1?0:r:255)).toString(16).slice(1)}},o={addMessage(e,t,n,s={}){const o=i.createElement("div",`fcw-message ${t}`),r=i.createElement("div","fcw-bubble-text");if(s.loading)r.innerHTML='<span class="fcw-loading">●●●</span>';else{if(s.streaming)return r.innerHTML="",o.appendChild(r),e.appendChild(o),this.scrollToBottom(e),void this.streamTextToBubble(r,n);r.innerHTML=i.formatMarkdown(n)}o.appendChild(r),e.appendChild(o),this.scrollToBottom(e)},streamTextToBubble(e,t){let n=0;const s=i.formatMarkdown(t),o=i.createElement("div","",s),r=o.textContent||o.innerText||"",a=()=>{n<=r.length?(e.textContent=r.slice(0,n),n++,setTimeout(a,l._config.typingSpeed)):e.innerHTML=s};a()},scrollToBottom(e){e.scrollTop=e.scrollHeight},removeLoadingMessage(e){const t=e.lastChild;t&&t.querySelector(".fcw-loading")&&e.removeChild(t)}},r={isResizing:!1,resizeDirection:"",startX:0,startY:0,startWidth:0,startHeight:0,startLeft:0,startRight:0,startTop:0,startBottom:0,resizeHandles:[],createResizeHandles(e,t){if(!t.resizable)return;[{direction:"nw",cursor:"nw-resize"},{direction:"n",cursor:"n-resize"},{direction:"ne",cursor:"ne-resize"},{direction:"e",cursor:"e-resize"},{direction:"se",cursor:"se-resize"},{direction:"s",cursor:"s-resize"},{direction:"sw",cursor:"sw-resize"},{direction:"w",cursor:"w-resize"}].forEach(t=>{const n=i.createElement("div",`fcw-resize-handle fcw-resize-${t.direction}`);n.style.cursor=t.cursor,n.dataset.direction=t.direction,e.appendChild(n),this.resizeHandles.push(n)}),this.bindResizeEvents(e,t)},bindResizeEvents(e,n){this.resizeHandles.forEach(t=>{t.addEventListener("mousedown",i=>{i.preventDefault(),i.stopPropagation(),this.startResize(i,e,n,t.dataset.direction)})}),t.addEventListener("mousemove",t=>{this.isResizing&&this.handleResize(t,e,n)}),t.addEventListener("mouseup",()=>{this.stopResize()})},startResize(n,i,s,o){this.isResizing=!0,this.resizeDirection=o,this.startX=n.clientX,this.startY=n.clientY,this.startWidth=i.offsetWidth,this.startHeight=i.offsetHeight;const r=i.getBoundingClientRect();this.startLeft=r.left,this.startRight=e.innerWidth-r.right,this.startTop=r.top,this.startBottom=e.innerHeight-r.bottom,t.body.style.cursor=this.getCursorForDirection(o),t.body.style.userSelect="none"},handleResize(e,t,n){if(!this.isResizing)return;const i=e.clientX-this.startX,s=e.clientY-this.startY;let o=this.startWidth,r=this.startHeight,a=this.startLeft,l=this.startRight;switch(this.resizeDirection){case"nw":o=this.startWidth-i,r=this.startHeight-s,a=this.startLeft+i;break;case"n":r=this.startHeight-s;break;case"ne":o=this.startWidth+i,r=this.startHeight-s,l=this.startRight-i;break;case"e":o=this.startWidth+i,l=this.startRight-i;break;case"se":o=this.startWidth+i,r=this.startHeight+s,l=this.startRight-i;break;case"s":r=this.startHeight+s;break;case"sw":o=this.startWidth-i,r=this.startHeight+s,a=this.startLeft+i;break;case"w":o=this.startWidth-i,a=this.startLeft+i}o=Math.max(n.minWidth,Math.min(n.maxWidth,o)),r=Math.max(n.minHeight,Math.min(n.maxHeight,r)),t.style.width=o+"px",t.style.height=r+"px";"right"===("bottom-left"===n.position?"left":"right")?t.style.right=l+"px":t.style.left=a+"px"},getCursorForDirection:e=>({nw:"nw-resize",n:"n-resize",ne:"ne-resize",e:"e-resize",se:"se-resize",s:"s-resize",sw:"sw-resize",w:"w-resize"}[e]||"default"),stopResize(){this.isResizing&&(this.isResizing=!1,t.body.style.cursor="",t.body.style.userSelect="")}},a={extractReply:e=>e&&e.reply?e.reply:e&&e.output?e.output:e&&e.message?e.message:""},l={_config:{},_elements:{},_isOpen:!1,_onUserRequest:null,init(e={}){if("loading"!==t.readyState){this._config={...n,...e},this._config.sessionId||(this._config.sessionId=i.generateSessionId());try{this._createStyles(),this._createWidget(),this._bindEvents(),this._config.welcomeMessage&&o.addMessage(this._elements.messages,"bot",this._config.welcomeMessage)}catch(e){console.error("[FloatingChatWidget] Initialization error:",e)}}else t.addEventListener("DOMContentLoaded",()=>this.init(e))},onUserRequest(e){this._onUserRequest=e},reply(e){i.validateMessageLength(e,this._config.maxMessageLength)&&o.addMessage(this._elements.messages,"bot",e)},toggle(){this._toggleWidget()},open(){this._isOpen||this._toggleWidget()},close(){this._isOpen&&this._toggleWidget()},_createStyles(){s.createStyles(this._config)},_createWidget(){const e=i.createElement("div","fcw-bubble",this._config.bubbleIcon);t.body.appendChild(e);const n=this._config.enableFileUpload?`<button class="fcw-file-btn" type="button" title="Attach files">\n          <span>📎</span>\n          <input type="file" class="fcw-file-input" accept="${this._config.allowedFileTypes.join(",")}" multiple />\n        </button>`:"",s=i.createElement("div","fcw-widget",`\n        <div class="fcw-header">${this._config.title}</div>\n        <div class="fcw-messages"></div>\n        <div class="fcw-file-preview" style="display: none;"></div>\n        <form class="fcw-input-row" autocomplete="off">\n          <input class="fcw-input" type="text" placeholder="${this._config.placeholder}" maxlength="${this._config.maxMessageLength}" />\n          ${n}\n          <button class="fcw-send-btn" type="submit">➤</button>\n        </form>\n      `);t.body.appendChild(s),this._elements={bubble:e,widget:s,messages:s.querySelector(".fcw-messages"),input:s.querySelector(".fcw-input"),form:s.querySelector(".fcw-input-row"),sendBtn:s.querySelector(".fcw-send-btn"),fileBtn:s.querySelector(".fcw-file-btn"),fileInput:s.querySelector(".fcw-file-input"),filePreview:s.querySelector(".fcw-file-preview")},this._attachedFiles=[],r.createResizeHandles(s,this._config)},_bindEvents(){this._elements.bubble.addEventListener("click",()=>this._toggleWidget()),this._elements.form.addEventListener("submit",e=>{e.preventDefault(),this._handleFormSubmit()}),this._elements.input.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this._handleFormSubmit())}),this._config.enableFileUpload&&this._elements.fileInput&&this._elements.fileInput.addEventListener("change",e=>{this._handleFileSelect(e)})},_handleFileSelect(e){const t=Array.from(e.target.files);if(0!==t.length){this._attachedFiles=[];for(const e of t){const t=i.validateFile(e,this._config);t.valid?this._attachedFiles.push(e):this._showError(`${e.name}: ${t.error}`)}0!==this._attachedFiles.length?this._showFilePreview(this._attachedFiles):e.target.value=""}},_showFilePreview(e){const t=this._elements.filePreview;let n='<div class="fcw-files-container">';e.forEach((e,t)=>{n+=`\n          <div class="fcw-file-item" data-index="${t}">\n            <div class="fcw-file-info">\n              <span class="fcw-file-icon">📄</span>\n              <span>${e.name} (${i.formatFileSize(e.size)})</span>\n            </div>\n            <button class="fcw-file-remove" data-index="${t}" type="button">✕</button>\n          </div>\n        `}),n+="</div>",t.innerHTML=n,t.style.display="block";t.querySelectorAll(".fcw-file-remove").forEach(e=>{e.addEventListener("click",e=>{const t=parseInt(e.target.dataset.index);this._removeAttachedFile(t)})})},_removeAttachedFile(e=null){null!==e?(this._attachedFiles.splice(e,1),this._attachedFiles.length>0?this._showFilePreview(this._attachedFiles):(this._elements.filePreview.style.display="none",this._elements.fileInput&&(this._elements.fileInput.value=""))):(this._attachedFiles=[],this._elements.filePreview.style.display="none",this._elements.fileInput&&(this._elements.fileInput.value=""))},async _handleFormSubmit(){const e=this._elements.input.value.trim(),t=this._attachedFiles.length>0;if(!e&&!t)return;if(e&&!i.validateMessageLength(e,this._config.maxMessageLength))return void this._showError("Message is too long.");let n=[];if(t)try{for(const e of this._attachedFiles){const t=await i.fileToBase64(e),s=e.type||"application/octet-stream",o=e.name.split(".").pop()||"",r=s.split("/")[0]||"application";n.push({fileName:e.name,fileSize:`${e.size} bytes`,fileExtension:o,fileType:r,mimeType:s,data:t}),this._addFileMessage("user",e.name,i.formatFileSize(e.size))}}catch(e){return void this._showError("Failed to process files")}e&&o.addMessage(this._elements.messages,"user",e),this._elements.input.value="",this._elements.input.focus(),this._removeAttachedFile();const s={sessionId:this._config.sessionId,action:"sendMessage",chatInput:e||"",files:n};"function"==typeof this._onUserRequest?this._onUserRequest(s):this._sendToApi(s)},_addFileMessage(e,t,n){const s=i.createElement("div",`fcw-message ${e} file`),r=i.createElement("div","fcw-file-message",`<span class="fcw-file-icon">📎</span> ${t} (${n})`);s.appendChild(r),this._elements.messages.appendChild(s),o.scrollToBottom(this._elements.messages)},_showError(e){const t=i.createElement("div","fcw-error",e);this._elements.messages.appendChild(t),o.scrollToBottom(this._elements.messages),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},3e3)},_toggleWidget(){this._isOpen=!this._isOpen,this._isOpen?(this._elements.widget.classList.add("open"),setTimeout(()=>this._elements.input.focus(),this._config.animationDuration+50)):this._elements.widget.classList.remove("open")},async _sendToApi(e){o.addMessage(this._elements.messages,"bot","",{loading:!0});try{const t=await fetch(this._config.apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();o.removeLoadingMessage(this._elements.messages);const i=a.extractReply(n);i?o.addMessage(this._elements.messages,"bot",i,{streaming:!0}):o.addMessage(this._elements.messages,"bot","Sorry, I did not understand.")}catch(e){o.removeLoadingMessage(this._elements.messages),o.addMessage(this._elements.messages,"bot","AI agent connection error occurred.")}}};e.FloatingChatWidget=l}(window,document);